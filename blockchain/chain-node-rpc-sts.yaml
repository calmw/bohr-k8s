apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: chain-node-rpc
  namespace: bohr-prod
  labels:
    app.kubernetes.io/name: chain-node-rpc
spec:
  replicas: 3
  selector:
    matchLabels:
      app: chain-node-rpc
  template:
    metadata:
      labels:
        app: chain-node-rpc
        app.kubernetes.io/name: chain-node-rpc
    spec:
      terminationGracePeriodSeconds: 30
      volumes:
        - name: node-config
          configMap:
            name: node-config
        - name: genesis-config
          configMap:
            name: genesis-config
      containers:
        - name: chain-node-rpc
          image: 630968570112.dkr.ecr.ap-northeast-1.amazonaws.com/bohr-prod/chain-node-rpc:mainnet-f0f429-20260215192940
          imagePullPolicy: Always
          command: [ "bash", "-x", "/data/chain/bin/scripts/node_archive_start.sh" ]
          ports:
            - containerPort: 30303
            - containerPort: 8545
            - containerPort: 8546
          # ============ 资源限制配置 ============
          resources:
            requests:
              memory: "100Mi"
              cpu: "10m"
              ephemeral-storage: "25Gi"
            limits:
              memory: "5000Mi"
              cpu: "2500m"
              ephemeral-storage: "30Gi"
          livenessProbe:
            failureThreshold: 10
            initialDelaySeconds: 600
            periodSeconds: 300
            successThreshold: 1
            tcpSocket:
              port: 8545
            timeoutSeconds: 5
          readinessProbe:
            failureThreshold: 10
            initialDelaySeconds: 120
            periodSeconds: 300
            successThreshold: 1
            tcpSocket:
              port: 8545
            timeoutSeconds: 5
          env:
            - name: BASE_DIR
              value: "/data/app"
            - name: DATA_DIR
              value: "/data/app/node"
            - name: BIN_DIR
              value: "/data/chain/bin"
            - name: DB_ENGINE
              value: "pebble"
            - name: GC_MODE
              value: "archive"
            - name: STATE_SCHEME
              value: "hash"
            - name: SYNC_MODE
              value: "full"
            - name: PASSWORD
              value: "db4847e6338423"
            - name: HTTP_PORT
              value: "8545"
            - name: WS_PORT
              value: "8546"
            - name: P2P_PORT
              value: "30303"
            - name: METRICS_PORT
              value: "6060"
            - name: PPROF_PORT
              value: "7070"
            - name: HTTP_API
              value: "eth,net,web3,debug,txpool"
            - name: WS_API
              value: "eth,net,web3,debug,txpool"
            - name: TX_FEE_CAP # 允许通过 RPC 发送的单笔交易,最多可消耗的主币数量，作为手续费
              value: "1000"
            - name: PASSED_FORK_TIME
              value: "0"
            - name: LAST_HARDFORK_TIME # + 10
              value: "0"
            - name: RIALTO_HASH
              value: "0xca2edbed5514abdffd903b9f46e0f805c20c642ece48191fbd75bb510fa95b16"
            - name: NODE_TXT
            - name: BOOTNODES
              value: "enode://42ab750672f821b73d5ec5a1716105e1733713e0f312bfcfe9f210e28f4e88e38bd99d4906217893df11070b22ce4ab247022c8fbbebc547a47f2a1c72f533d4@18.179.76.29:30303,enode://2c1905b8a5e5be5c021dda48334aabed3b7fdd572d6e6196546aaee6961bac73fdb7c83e961238996e06235ae1cef25aea76ab22cb022a491854ae65b38fd537@52.68.163.149:30303,enode://536fbef2a4c15f055a628ee5335623df0c7f6d1617eb472ee07845525b3a10fa9ec6b594ee60b472ae4a5c065c11efc675d88271d1b3b169b8c6aec60467e4d6@54.64.166.104:30303,enode://e4a570ac45ce6535a5d11d4c8745fd398536a3eee8ebe6cb898f06fd732b7a0de5c46e9a986b526771274892a10e2e4ff80ad64a1801c9db25abc0b41fd33fac@35.75.248.115:30303,enode://485e8259cebfe798137c59ef28ebe52dd8d52c26e59d88bfe3d772d7b97926571856935fe32f6dcd35eb4f0ee93533f783feb773933fead92cf204364074ca8b@18.176.87.178:30303,enode://28440dab229e6881e741e70c557aeb29ea13d75aca63188e5152dbd6e4c2365cccb5879db30568422b0434edec47daee2205816cc48a23a9555c4c2eb1ead6f9@35.73.218.11:30303,enode://baa2844561f6278e437568628b89f7f672696ba7833788941568875874f0f18e902db1b010a6a8e2f9e49d23230c864016d64a44ab4bc0d6f9330de1384ca06f@18.180.116.96:30303"

          volumeMounts:
            - name: genesis-config
              mountPath: /data/app/config-src/genesis.json
              subPath: genesis.json
            - name: node-config
              mountPath: /data/app/config-src/config.toml
              subPath: config.toml
            - name: rpc-data
              mountPath: /data/app/node

  volumeClaimTemplates:
    - metadata:
        name: rpc-data
      spec:
        accessModes: [ "ReadWriteOnce" ]
        resources:
          requests:
            storage: 100Gi
