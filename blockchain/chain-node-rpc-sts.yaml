apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: chain-node-rpc
  namespace: bohr-prod
  labels:
    app.kubernetes.io/name: chain-node-rpc
spec:
  replicas: 3
  selector:
    matchLabels:
      app: chain-node-rpc
  template:
    metadata:
      labels:
        app: chain-node-rpc
        app.kubernetes.io/name: chain-node-rpc
    spec:
      terminationGracePeriodSeconds: 30
      volumes:
        - name: node-config
          configMap:
            name: node-config
        - name: genesis-config
          configMap:
            name: genesis-config
      containers:
        - name: chain-node-rpc
          image: 630968570112.dkr.ecr.ap-northeast-1.amazonaws.com/bohr-prod/chain-node-rpc:mainnet-f0f429-20260215192940
          imagePullPolicy: Always
          command: [ "bash", "-x", "/data/chain/bin/scripts/node_archive_start.sh" ]
          ports:
            - containerPort: 30303
            - containerPort: 8545
            - containerPort: 8546
          # ============ 资源限制配置 ============
          resources:
            requests:
              memory: "100Mi"
              cpu: "10m"
              ephemeral-storage: "25Gi"
            limits:
              memory: "5000Mi"
              cpu: "2500m"
              ephemeral-storage: "30Gi"
          livenessProbe:
            failureThreshold: 10
            initialDelaySeconds: 600
            periodSeconds: 300
            successThreshold: 1
            tcpSocket:
              port: 8545
            timeoutSeconds: 5
          readinessProbe:
            failureThreshold: 10
            initialDelaySeconds: 120
            periodSeconds: 300
            successThreshold: 1
            tcpSocket:
              port: 8545
            timeoutSeconds: 5
          env:
            - name: BASE_DIR
              value: "/data/app"
            - name: DATA_DIR
              value: "/data/app/node"
            - name: BIN_DIR
              value: "/data/chain/bin"
            - name: DB_ENGINE
              value: "pebble"
            - name: GC_MODE
              value: "archive"
            - name: STATE_SCHEME
              value: "hash"
            - name: SYNC_MODE
              value: "full"
            - name: PASSWORD
              value: "db4847e6338423"
            - name: HTTP_PORT
              value: "8545"
            - name: WS_PORT
              value: "8546"
            - name: P2P_PORT
              value: "30303"
            - name: METRICS_PORT
              value: "6060"
            - name: PPROF_PORT
              value: "7070"
            - name: HTTP_API
              value: "eth,net,web3,debug,txpool"
            - name: WS_API
              value: "eth,net,web3,debug,txpool"
            - name: TX_FEE_CAP # 允许通过 RPC 发送的单笔交易,最多可消耗的主币数量，作为手续费
              value: "1000"
            - name: PASSED_FORK_TIME
              value: "0"
            - name: LAST_HARDFORK_TIME # + 10
              value: "0"
            - name: RIALTO_HASH
              value: "0xb91bb8ad29b0ca546fbf48185c1957ffcc52e8cafb007d2874b8e2af371b1bbb"
            - name: NODE_TXT
            - name: BOOTNODES
              value: "enode://8f33f97bdabef1058bd340ebc8ec8849f02e9cd608a07fded227e1cc8836c6d4c759bc22c566fb4bc7cdca6187a366be48543827e58435268d512751765fe60a@18.179.76.29:30303,enode://612f7538833a6dc22227b4807f5a082dba1f902f9efc217f038bee2822889738a083c26a4992b570621b351dee8d263c00c22c3ab42440e165a4f9eae44995cc@52.68.163.149:30303,enode://fc738f90b0c2b4a8dc768e9908a8e8dfbe400db1eb588c26d4240d7d7dd73291168e947c86fb33862f23708abbca5e5b38127c4a75ab59e4066e9f91cc240dfd@54.64.166.104:30303,enode://8b8ccfb21ef802f7ea9ad4fdf2667b01c4ec1de00086607fa9c03fdb865c8f8fc0df20e6cd3b0fd3c018ea4fe6b37c8f55feaab9ef445bb2d3beda2390881047@35.75.248.115:30303,enode://e510e0ae0d5d66560fdbf82dc7ecd62a4d688c17d4be4958a22aa1dc9737f26aabc6f4696a1f8f2ecb52a537b74ff0953b3444533db3f738056b00188ee7294a@18.176.87.178:30303,enode://c9ba9c8ccd6df44b2c43f380e5173742a070e96d443bbe544e9e5374ed25501b6bc75d668c2db9f48fa10046e2743239c461537b052271962b8a0c53dc1b8837@35.73.218.11:30303,enode://3eddcbf9669e2f532610a3a74e0f9c8c64ca2ee6b64360dd376828a44e237bf74b5ea611cfb467b6d9e59bb2545163c1ae725378350ee991ecfe42cb76230bee@18.180.116.96:30303"

          volumeMounts:
            - name: genesis-config
              mountPath: /data/app/config-src/genesis.json
              subPath: genesis.json
            - name: node-config
              mountPath: /data/app/config-src/config.toml
              subPath: config.toml
            - name: rpc-data
              mountPath: /data/app/node

  volumeClaimTemplates:
    - metadata:
        name: rpc-data
      spec:
        accessModes: [ "ReadWriteOnce" ]
        resources:
          requests:
            storage: 100Gi
