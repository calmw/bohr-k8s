apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: chain-node-rpc
  namespace: bohr-prod
  labels:
    app.kubernetes.io/name: chain-node-rpc
spec:
  replicas: 3
  selector:
    matchLabels:
      app: chain-node-rpc
  template:
    metadata:
      labels:
        app: chain-node-rpc
        app.kubernetes.io/name: chain-node-rpc
    spec:
      terminationGracePeriodSeconds: 30
      volumes:
        - name: node-config
          configMap:
            name: node-config
        - name: genesis-config
          configMap:
            name: genesis-config
      containers:
        - name: chain-node-rpc
          image: 630968570112.dkr.ecr.ap-northeast-1.amazonaws.com/bohr-prod/chain-node-rpc:mainnet-f0f429-20260215192940
          imagePullPolicy: Always
          command: [ "bash", "-x", "/data/chain/bin/scripts/node_archive_start.sh" ]
          ports:
            - containerPort: 30303
            - containerPort: 8545
            - containerPort: 8546
          # ============ 资源限制配置 ============
          resources:
            requests:
              memory: "100Mi"
              cpu: "10m"
              ephemeral-storage: "25Gi"
            limits:
              memory: "5000Mi"
              cpu: "2500m"
              ephemeral-storage: "30Gi"
          livenessProbe:
            failureThreshold: 10
            initialDelaySeconds: 600
            periodSeconds: 300
            successThreshold: 1
            tcpSocket:
              port: 8545
            timeoutSeconds: 5
          readinessProbe:
            failureThreshold: 10
            initialDelaySeconds: 120
            periodSeconds: 300
            successThreshold: 1
            tcpSocket:
              port: 8545
            timeoutSeconds: 5
          env:
            - name: BASE_DIR
              value: "/data/app"
            - name: DATA_DIR
              value: "/data/app/node"
            - name: BIN_DIR
              value: "/data/chain/bin"
            - name: DB_ENGINE
              value: "pebble"
            - name: GC_MODE
              value: "archive"
            - name: STATE_SCHEME
              value: "hash"
            - name: SYNC_MODE
              value: "full"
            - name: PASSWORD
              value: "db4847e6338423"
            - name: HTTP_PORT
              value: "8545"
            - name: WS_PORT
              value: "8546"
            - name: P2P_PORT
              value: "30303"
            - name: METRICS_PORT
              value: "6060"
            - name: PPROF_PORT
              value: "7070"
            - name: HTTP_API
              value: "eth,net,web3,debug,txpool"
            - name: WS_API
              value: "eth,net,web3,debug,txpool"
            - name: TX_FEE_CAP # 允许通过 RPC 发送的单笔交易,最多可消耗的主币数量，作为手续费
              value: "1000"
            - name: PASSED_FORK_TIME
              value: "0"
            - name: LAST_HARDFORK_TIME # + 10
              value: "0"
            - name: RIALTO_HASH
              value: "0x161a4ff8b4c95e95b314899c4ea8f9782c4ae8851362ffe0d47c0b8a05f7b784"
            - name: BOOTNODES
              value: "enode://38e395894308c40477089377509ba6676dc6e2fe2dbb69e11c8f08793b13c7eea79fa884c973cd2da25f55faaf67fab0c51f2d851add2411cf24ad02a873916f@18.179.76.29:30303,enode://e600aceed45952230c07838e0d7e55f975bc4f760faf01c768c2c00d155927d64d855144ca8180a8733316d16d1b51eacae9d1f9b19bf51ea0f92a94ed93492f@52.68.163.149:30303,enode://aad0f9ca866ab5850ef19a91d128c1fa1c5aa9343e0553e810c4a9a90381f44005d704d3403b4246fe173c67a8639eb31ef7c2720d0a54e379f86e7432ce9828@54.64.166.104:30303,enode://5673967358559592b6d99c2eb41b6d10f05a1d83524cafbd8aaa6311d84fb337543f7b8e8ab1dc97ba91b4e5f908e44302a96f0d2b8057b001ed7fb6639a366a@35.75.248.115:30303,enode://a1b653a3dcfbd0ff53527d701fa90efd115764ff2387b0da746484f1e40fb4847d9b05ef59ccedb6e9df795fee3ef9ccdee5305e07e4377b8ad334257cdfb8ec@18.176.87.178:30303,enode://8d92d1eb3150632e263e28bc23585bc6ebf1f7aacbfd0e966407e3ab0563b537e3d77970d9f5cc29fbf6e368410a5aea430e4a51160ac70fae38d07116f49f1b@35.73.218.11:30303,enode://e575dc6663068b76134bc6ca222c37b02d2d42025c1b382f758a8752a4edf4296dd033574ea4daea2b8c1c4c58718f1bbf212e977156e2ba90610fa3eec39bbf@18.180.116.96:30303"

          volumeMounts:
            - name: genesis-config
              mountPath: /data/app/config-src/genesis.json
              subPath: genesis.json
            - name: node-config
              mountPath: /data/app/config-src/config.toml
              subPath: config.toml
            - name: rpc-data
              mountPath: /data/app/node

  volumeClaimTemplates:
    - metadata:
        name: rpc-data
      spec:
        accessModes: [ "ReadWriteOnce" ]
        resources:
          requests:
            storage: 350Gi
