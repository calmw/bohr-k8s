apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: scan-frontend
  namespace: bohr-prod
  annotations:
    nginx.ingress.kubernetes.io/proxy-http-version: "1.1"
    nginx.ingress.kubernetes.io/use-regex: "true"
    # WebSocket 专用长连接配置
    nginx.ingress.kubernetes.io/proxy-read-timeout: "86400" # 24小时长连接
    nginx.ingress.kubernetes.io/proxy-send-timeout: "86400"
    nginx.ingress.kubernetes.io/server-snippets: |
      location / {
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
      }
    # 启用并配置CORS
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    # 允许携带凭证（如果前端请求有cookie/token等）
    nginx.ingress.kubernetes.io/cors-allow-credentials: "true"
    # 允许的HTTP方法
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, OPTIONS"
    # 允许的请求头
    nginx.ingress.kubernetes.io/cors-allow-headers: "DNT,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization"
    # CSP 安全策略
#    nginx.ingress.kubernetes.io/content-security-policy: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://rpc.bohr.life https://pulse.walletconnect.org https://api.web3modal.org;"
    nginx.ingress.kubernetes.io/content-security-policy: >
      default-src 'self';
      script-src 'self' 'unsafe-inline' 'unsafe-eval' blob:;
      style-src 'self' 'unsafe-inline';
      img-src 'self' data: blob:;
      font-src 'self' data:;
      connect-src 'self'
        https://scan.bohr.life
        http://scan.bohr.life
        ws://scan.bohr.life
        wss://scan.bohr.life
        https://api-scan.bohr.life
        https://rpc.bohr.life
        https://rpc.walletconnect.org
        https://pulse.walletconnect.org
        https://api.web3modal.org
        wss://*.walletconnect.com;
      frame-src 'self';
      worker-src 'self' blob:;

spec:
  ingressClassName: nginx-public
  rules:
    - host: scan.bohr.life
      http:
        paths:
          # Phoenix / Blockscout WebSocket
          - path: /socket
            pathType: Prefix
            backend:
              service:
                name: scan-backend
                port:
                  number: 4000

          # 1. 精确匹配关键静态文件 (优先级最高)
          - path: /envs.js
            pathType: Exact
            backend:
              service:
                name: scan-frontend
                port:
                  number: 3000
          - path: /manifest.json
            pathType: Exact
            backend:
              service:
                name: scan-frontend
                port:
                  number: 3000
          # 2. 前缀匹配静态资源目录
          - path: /assets
            pathType: Prefix
            backend:
              service:
                name: scan-frontend
                port:
                  number: 3000
          - path: /_next/static
            pathType: Prefix
            backend:
              service:
                name: scan-frontend
                port:
                  number: 3000
          # 3. API路由：使用正则捕获组，处理可能的重复路径问题
          - path: /api/v2(/|$)(.*)   # 匹配 /api/v2 及 /api/v2/...
            pathType: ImplementationSpecific
            backend:
              service:
                name: scan-backend
                port:
                  number: 4000
          - path: /api
            pathType: Prefix
            backend:
              service:
                name: scan-backend
                port:
                  number: 4000
          # 4. 默认路由（前端SPA，优先级最低）
          - path: /
            pathType: Prefix
            backend:
              service:
                name: scan-frontend
                port:
                  number: 3000